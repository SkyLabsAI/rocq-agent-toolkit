<doc text="Per-task output format of the Rocq pipeline.">

type task_kind <doc text="Kind of task."> = [
  | FullProofTask <doc text="Fully proving a Rocq goal.">
  | OtherTask of string <doc text="User defined task kind.">
]

type task_status <doc text="Task status upon completion."> = [
  | Success <doc text="Task completed successfully.">
  | Failure <doc text="Task failed.">
]

type resource_exhaustion_kind <doc text="Kind of resource exhaustion."> = [
  | Timeout of int <doc text="Exceeded timelimit in seconds.">
  | MaxLLMCalls of int <doc text="Exceeded LLM call limit.">
]

type failure_reason <doc text="Reason for task failure."> = [
  | ResourceExhaustion of resource_exhaustion_kind <doc text="Resource exhaustion.">
  | ExecutionError of string <doc text="Unrecoverable error.">
  | Other of string <doc text="User defined failure reason.">
]

type token_counts <doc text="Aggregated LLM token metrics for task."> = {
  ~input_tokens <doc text="Total LLM input tokens for task."> : int;
  ~output_tokens <doc text="Total LLM output tokens for task."> : int;
  ~total_tokens <doc text="Total LLM tokens for task."> : int;
}

type resource_usage <doc text="Aggregated execution time metrics for task."> = {
  ~execution_time_sec <doc text="Total execution time for task."> : float;
  ~cpu_time_sec <doc text="Total CPU execution time for task."> : float;
  ~gpu_time_sec <doc text="Total GPU execution time for task."> : float;
}

type metrics <doc text="Aggregated metrics for task."> = {
  ~llm_invocation_count <doc text="Total LLM calls for task."> : int;
  ~token_counts <doc text="Aggregated LLM token metrics for task."> <python default="TokenCounts()"> : token_counts;
  ~resource_usage <doc text="Aggregated execution time metrics for task."> <python default="ResourceUsage()"> : resource_usage;
  ~custom <doc text="Additional user defined metrics."> <python default="None"> : abstract;
}

(* Simple key/value tags, represented as a JSON object mapping string->string. *)
type tags <doc text="User-defined tags as key/value pairs."> = (string * string) list <python repr="dict"> <json repr="object">

type metadata <doc text="Additional metadata for a task."> = {
  ~tags <doc text="User-defined tags for this task.">
    <python default="Tags({})"> : tags;
}

type agent_class_info <doc text="Agent class provenance for the run."> = {
  cls_checksum <doc text="Pseudo-unique checksum of the Agent class."> : string;
  cls_name <doc text="Name of the Agent class."> : string;
  cls_provenance <doc text="Provenance for the Agent class."> : abstract;
}

type agent_info <doc text="Agent instance provenance for the run."> = {
  cls_checksum <doc text="Checksum of the Agent class for correlation."> : string;
  checksum <doc text="Pseudo-unique checksum of the Agent instance."> : string;
  name <doc text="Name of the Agent instance."> : string;
  provenance <doc text="Provenance for the Agent instance."> : abstract;
}

type run_header <doc text="Run header entry for JSONL output."> = {
  type <doc text="Entry type (run)."> : string;
  run_id <doc text="Unique identifier for the run (UUID)."> : string;
  dataset_id <doc text="Unique name of the dataset on which agent is run."> : string;
  tags <doc text="Run-level tags from the environment."> : tags;
  agent_cls <doc text="Agent class provenance."> : agent_class_info;
  agent <doc text="Agent instance provenance."> : agent_info;
}

type task_output <doc text="Agent output for a single task."> = {
  type <doc text="Entry type (task)."> : string;
  task_kind <doc text="Kind of task."> : task_kind;
  task_id <doc text="Unique task identifier (file+task locator)."> : string;
  ?trace_id <doc text="Unique trace identifier for corresponding opentelemetry output."> : string option;
  timestamp_utc <doc text="Timestamp when task began (ISO 8601)."> : string;
  status <doc text="Task status upon completion."> : task_status;
  ?failure_reason <doc text="Reason for task failure."> : failure_reason option;
  ~results <doc text="Agent results after task completion."> <python default="None"> : abstract;
  metrics <doc text="Aggregated metrics for task."> : metrics;
  ?metadata <doc text="Additional metadata, including task tags."> : metadata option;
}
